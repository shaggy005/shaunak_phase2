/* This file was generated by the Hex-Rays decompiler version 9.2.0.250908.
   Copyright (c) 2007-2021 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

__int64 (**init_proc())(void);
void sub_1020();
// int printf(const char *format, ...);
// size_t strcspn(const char *s, const char *reject);
// int sprintf(char *s, const char *format, ...);
// size_t strlen(const char *s);
// const unsigned __int16 **__ctype_b_loc(void);
// int strcmp(const char *s1, const char *s2);
// int puts(const char *s);
// __int64 __fastcall MD5(_QWORD, _QWORD, _QWORD); weak
// char *fgets(char *s, int n, FILE *stream);
void __fastcall __noreturn start(__int64 a1, __int64 a2, void (*a3)());
FILE **sub_14C0();
__int64 sub_14F0();
FILE **sub_1530();
__int64 sub_1580();
void term_proc();
// int _cxa_finalize(void *);
// int _libc_start_main(int (*main)(int, char **, char **), int argc, char **ubp_av, void (*init)(), void (*fini)(), void (*rtld_fini)(), void *stack_end);
// __int64 _gmon_start__(void); weak

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN main;
const char aTheAncientDrag[70] = "   The ancient dragon roars: \"Begone, unworthy!\"   \n           __,---/"; // idb
void *off_4058 = &off_4058; // idb
FILE *stdin; // idb
char byte_4068; // weak


//----- (0000000000001000) ----------------------------------------------------
__int64 (**init_proc())(void)
{
  __int64 (**result)(void); // rax

  result = &_gmon_start__;
  if ( &_gmon_start__ )
    return (__int64 (**)(void))_gmon_start__();
  return result;
}
// 40D8: using guessed type __int64 _gmon_start__(void);

//----- (0000000000001020) ----------------------------------------------------
void sub_1020()
{
  JUMPOUT(0);
}
// 1026: control flows out of bounds to 0

//----- (00000000000010D0) ----------------------------------------------------
__int64 __fastcall main(int a1, char **a2, char **a3)
{
  const unsigned __int16 *v3; // rsi
  char *v4; // rax
  unsigned __int16 v5; // cx
  unsigned __int16 v6; // dx
  unsigned int v7; // ebp
  char *v9; // r12
  size_t v10; // rax
  char *v11; // rbp
  int v12; // edx
  char *v13; // rdi
  char v14[2]; // [rsp+Ch] [rbp-10Ch] BYREF
  char v15; // [rsp+Eh] [rbp-10Ah]
  char v16[16]; // [rsp+10h] [rbp-108h] BYREF
  char s1[32]; // [rsp+20h] [rbp-F8h] BYREF
  char v18; // [rsp+40h] [rbp-D8h] BYREF
  char s[16]; // [rsp+50h] [rbp-C8h] BYREF
  __int128 v20; // [rsp+60h] [rbp-B8h]
  __int128 v21; // [rsp+70h] [rbp-A8h]
  __int128 v22; // [rsp+80h] [rbp-98h]
  __int128 v23; // [rsp+90h] [rbp-88h]
  __int128 v24; // [rsp+A0h] [rbp-78h]
  __int128 v25; // [rsp+B0h] [rbp-68h]
  __int128 v26; // [rsp+C0h] [rbp-58h]
  unsigned __int64 v27; // [rsp+D8h] [rbp-40h]

  v27 = __readfsqword(0x28u);
  puts(
    "                       (Knight's Adventure)                \n"
    "\n"
    "         O                                              \n"
    "        <M>            .---.                            \n"
    "        /W\\           ( -.- )--------.                  \n"
    "   ^    \\|/            \\_o_/         )    ^             \n"
    "  /|\\    |     *      ~~~~~~~       /    /|\\            \n"
    "  / \\   / \\  /|\\                    /    / \\            \n"
    "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n"
    "Welcome, traveler. A mighty dragon blocks the gate.\n"
    "Speak the secret incantation (10 runic letters) to continue.\n");
  *(_OWORD *)s = 0;
  v20 = 0;
  v21 = 0;
  v22 = 0;
  v23 = 0;
  v24 = 0;
  v25 = 0;
  v26 = 0;
  printf("Enter your incantation: ");
  if ( !fgets(s, 128, stdin) )
  {
    puts("\nSomething went awry. Fare thee well...");
    return 1;
  }
  s[strcspn(s, "\n")] = 0;
  if ( strlen(s) != 10 )
  {
    puts("\nScribe's note: The incantation must be exactly 10 runic symbols.");
    puts(aTheAncientDrag);
    return 1;
  }
  v3 = *__ctype_b_loc();
  v4 = s;
  do
  {
    v5 = v3[(unsigned __int8)*v4];
    if ( (v5 & 0x400) == 0 || (v6 = v3[(unsigned __int8)v4[1]], (v6 & 0x400) == 0) )
    {
      puts("\nThe runes fail to align. The incantation is impure.");
      puts(aTheAncientDrag);
      return 1;
    }
    if ( (v5 & 0x100) != 0 && (v6 & 0x100) != 0 || (v5 & 0x200) != 0 && (v6 & 0x200) != 0 )
    {
      puts("\nThe ancient seals do not resonate with your runes.");
      puts(aTheAncientDrag);
      return 1;
    }
    v4 += 2;
  }
  while ( v4 != &s[10] );
  if ( (s[0] ^ s[1]) != 36 )
  {
    puts("\nThe wards reject your Pair 1.");
    puts(aTheAncientDrag);
    return 1;
  }
  if ( s[1] != 106 )
  {
    puts("\nThe wards reject your Pair 1 second char.");
    puts(aTheAncientDrag);
    return 1;
  }
  if ( (s[3] ^ s[2]) != 56 )
  {
    puts("\nThe wards reject your Pair 2.");
    puts(aTheAncientDrag);
    return 1;
  }
  if ( s[3] != 83 )
  {
    puts("\nThe wards reject your Pair 2 second char.");
    puts(aTheAncientDrag);
    return 1;
  }
  v15 = 0;
  v9 = v16;
  *(_WORD *)v14 = __ROL2__(*(_WORD *)&s[4], 8);
  v10 = strlen(v14);
  v11 = s1;
  MD5(v14, v10, v16);
  do
  {
    v12 = (unsigned __int8)*v9;
    v13 = v11;
    v11 += 2;
    ++v9;
    sprintf(v13, "%02x", v12);
  }
  while ( &v18 != v11 );
  v18 = 0;
  v7 = strcmp(s1, "33a3192ba92b5a4803c9a9ed70ea5a9c");
  if ( v7 )
  {
    puts("\nThe dragon's eyes glow red... The final seal remains locked.");
    puts(aTheAncientDrag);
    return 1;
  }
  if ( (s[7] ^ s[6]) != 56 )
  {
    puts("\nThe wards reject your Pair 4.");
    puts(aTheAncientDrag);
    return 1;
  }
  if ( s[7] != 97 )
  {
    puts("\nThe wards reject your Pair 4 second char.");
    puts(aTheAncientDrag);
    return 1;
  }
  if ( (s[8] ^ s[9]) != 32 )
  {
    puts("\nThe wards reject your Pair 5.");
    puts(aTheAncientDrag);
    return 1;
  }
  if ( s[9] != 105 )
  {
    puts("\nThe wards reject your Pair 5 second char.");
    puts(aTheAncientDrag);
    return 1;
  }
  printf(
    "\n%s\n",
    "   The kingdom's gates open, revealing the hidden realm...    \n"
    "                         ( (                                 \n"
    "                          \\ \\                                \n"
    "                     .--.  ) ) .--.                         \n"
    "                    (    )/_/ (    )                        \n"
    "                     '--'      '--'                         \n"
    "    \"Huzzah! Thy incantation is true. Onward, brave knight!\" \n");
  printf("The final scroll reveals your reward: KCTF{%s}\n\n", s);
  return v7;
}
// 10B0: using guessed type __int64 __fastcall MD5(_QWORD, _QWORD, _QWORD);

//----- (0000000000001490) ----------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __fastcall __noreturn start(__int64 a1, __int64 a2, void (*a3)())
{
  __int64 v3; // rax
  int v4; // esi
  __int64 v5; // [rsp-8h] [rbp-8h] BYREF
  char *retaddr; // [rsp+0h] [rbp+0h] BYREF

  v4 = v5;
  v5 = v3;
  _libc_start_main((int (*)(int, char **, char **))main, v4, &retaddr, 0, 0, a3, &v5);
  __halt();
}
// 149A: positive sp value 8 has been found
// 14A1: variable 'v3' is possibly undefined

//----- (00000000000014C0) ----------------------------------------------------
FILE **sub_14C0()
{
  return &stdin;
}

//----- (00000000000014F0) ----------------------------------------------------
__int64 sub_14F0()
{
  return 0;
}

//----- (0000000000001530) ----------------------------------------------------
FILE **sub_1530()
{
  FILE **result; // rax

  if ( !byte_4068 )
  {
    if ( &_cxa_finalize )
      _cxa_finalize(off_4058);
    result = sub_14C0();
    byte_4068 = 1;
  }
  return result;
}
// 4068: using guessed type char byte_4068;

//----- (0000000000001580) ----------------------------------------------------
// attributes: thunk
__int64 sub_1580()
{
  return sub_14F0();
}

//----- (000000000000158C) ----------------------------------------------------
void term_proc()
{
  ;
}

// nfuncs=32 queued=9 decompiled=9 lumina nreq=0 worse=0 better=0
// ALL OK, 9 function(s) have been successfully decompiled
